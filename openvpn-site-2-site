SERVER-A


cd  /etc/openvpn/
openvpn --genkey --secret mykey.key

# Note: copy this mykey.key to SERVER-B -ïƒ  /etc/openvpn

Vim vpc1-to-vpc2.conf

#COPY BELOW SECTION
###START###
# Sample OpenVPN configuration file using a pre-shared static key

# Port to use: 1194 is the official IANA port number
port 1194

# Use a dynamic tun device.
dev tun

# Remote peer and network
#remote SERVER-B-PUBLIC-IP #Note: Not necessary IF this SERVER A is SERVER & SERVER B is Client
route 192.168.1.0 255.255.255.0

# Configure local and remote VPN endpoints
ifconfig 10.1.1.1 10.1.1.2


# The pre-shared static key
secret mykey.key

###END###

 systemctl daemon-reload
 systemctl restart openvpn
 
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE

iptables -A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT

 iptables -A FORWARD -j ACCEPT 
 iptables -t nat -A POSTROUTING -j MASQUERADE
https://unix.stackexchange.com/questions/283801/iptables-forward-traffic-to-vpn-tunnel-if-open

#IP Forwarding
cat /proc/sys/net/ipv4/ip_forward
0
Than
echo 1 > /proc/sys/net/ipv4/ip_forward
To make the change permanent insert or edit the following line in edit /etc/sysctl.conf:
net.ipv4.ip_forward = 1

sysctl -p



 systemctl daemon-reload
 systemctl restart openvpn







SERVER-B



# cd  /etc/openvpn/
# vim vpc2-to-vpc1.conf
###START###
# Sample OpenVPN configuration file using a pre-shared static key
# Port to use: 1194 is the official IANA port number
port 1194

# Use a dynamic tun device.
dev tun

# Remote peer and network
remote SERVER-A-PUBLIC-IP   #Note: This is must
route 172.31.0.0 255.255.0.0

# Configure local and remote VPN endpoints
ifconfig 10.1.1.2 10.1.1.1


# The pre-shared static key
secret mykey.key

###END###

 systemctl daemon-reload
 systemctl restart openvpn



iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE

iptables -A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT

 iptables -A FORWARD -j ACCEPT 

 iptables -t nat -A POSTROUTING -j MASQUERADE
 
https://unix.stackexchange.com/questions/283801/iptables-forward-traffic-to-vpn-tunnel-if-open

 systemctl daemon-reload
 systemctl restart openvpn



#IP Forwarding
cat /proc/sys/net/ipv4/ip_forward
0
Than
echo 1 > /proc/sys/net/ipv4/ip_forward
To make the change permanent insert or edit the following line in edit /etc/sysctl.conf:
net.ipv4.ip_forward = 1

sysctl -p

 systemctl daemon-reload
 systemctl restart openvpn

##############################################################################################
#LOGS

grep VPN /var/log/syslog
